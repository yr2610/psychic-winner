# cltools Parse 新バージョンアップデートガイド（ユーザー向け）

この度のアップデートでは、シート（`.txt`ファイルなど）の記述方法がより簡単になり、出力したいExcelやその他の文書構造を、より柔軟に制御できるようになりました。

## 💡 新しく追加された機能

### 1\. テンプレート呼び出しの回数指定（ループ）

特定のテンプレート（部品）を**決まった回数だけ繰り返し出力**したい場合に、回数を指定できるようになりました。

| 機能 | 説明 |
| :--- | :--- |
| **`*テンプレート名(N)`** | テンプレートを**N回**繰り返して出力します。 |

**✅ 使用例**

#### 🔹 基本的な繰り返し

例えば、請求書に5行分の明細（`Item`）が必要な場合。

| 元の記述（シート） | 最終的に展開されるイメージ（文書構造） |
| :--- | :--- |
| ` markdown # 請求先リスト *Item(5) // Itemテンプレートを5回繰り返す  ` | ` markdown # 請求先リスト * 1. 請求先名 (Itemの内容) * 2. 請求先名 (Itemの内容) * 3. 請求先名 (Itemの内容) * 4. 請求先名 (Itemの内容) * 5. 請求先名 (Itemの内容)  ` |

#### 🔹 繰り返し情報（連番）の利用

繰り返しの最中に、\*\*「今何回目か」\*\*の情報を取得して、連番や合計件数を表示できます。

| 変数名 | 説明 |
| :--- | :--- |
| **`{{ $index1 }}`** | **1から始まる**現在の回数（連番に便利） |
| **`{{ $count }}`** | ループ全体の**合計回数** |

| 元の記述（`Item`テンプレート） | 最終的に展開されるイメージ（文書構造） |
| :--- | :--- |
| ` markdown * {{ $index1 }}. 請求先名（全{{ $count }}件）  ` | ` markdown * 1. 請求先名（全5件） * 2. 請求先名（全5件） ... * 5. 請求先名（全5件）  ` |

-----

### 2\. 条件付きコンテンツ（`{{?expr}}`）による行の制御 と 警告の抑制（重要）

新バージョンでは、プレースホルダーの値によって行の削除が行われる場合の挙動が明確になりました。新しい構文である\*\*`{{?変数名}}`\*\*は、「値がない場合の警告を抑制する」目的で使います。

| 構文 | 説明 |
| :--- | :--- |
| **`{{変数名}}` （従来の記述）** | 値がない場合（`null`や`undefined`）は**行を削除**しますが、処理後に**警告メッセージ**が出ます。誤った変数名を指定した場合など、ミスに気づくために使います。 |
| **`{{?変数名}}` （新しい記述）** | 値がない場合（`null`や`undefined`）でも**行を削除**しますが、**警告メッセージは一切出ません**。データがないことを**意図して**行を制御したい場合に使います。 |

#### 🔹 **（補足）行が削除される条件**

以下のいずれかの条件を満たした場合、その行全体が削除されます。

  * 値が **`false`** の場合
  * 値が **`null`** または **`undefined`** の場合

> **値が空の文字列 (`""`) の場合は行は削除されず、空の文字列として出力されます。**

**✅ 使用例（警告を出さずに行を制御する）**

`optionalMemo`という変数にメモが設定されないことがある（`null`や`undefined`になる可能性がある）場合。

| 元の記述（シート） | 最終的に展開されるイメージ（`optionalMemo`に値がない場合） |
| :--- | :--- |
| ` markdown * 商品名: ノートPC * {{? optionalMemo }} 備考: {{ optionalMemo }}  ` | ` markdown * 商品名: ノートPC // 備考の行は完全に消える（警告なし）  ` |

-----

### 3\. プレースホルダー内での計算や条件判定

値を参照するプレースホルダー`{{...}}`の中で、**簡単な計算**や**条件分岐の式**を直接記述できるようになりました。

| 機能 | 説明 |
| :--- | :--- |
| **`{{ A * B }}`** | 変数AとBを掛け算した結果を出力。 |
| **`{{ A > B ? "Yes" : "No" }}`** | AがBより大きければ"Yes"、そうでなければ"No"を出力。 |

**✅ 使用例（計算の記述）**

```markdown
@init: price = 1000
@init: taxRate = 1.10

* 税抜金額: {{ price }}
* 税込金額: {{ price * taxRate }} // ★ プレースホルダー内で計算を実行
```

-----

### 4\. 新しい変数定義方法（`&Name:` アンカー）

シートの記述の中で、リスト項目として**変数名とその値**を定義できるようになりました。この行自体は**最終的な出力には影響しません**が、後でその変数を参照できます。

| 構文 | 説明 |
| :--- | :--- |
| **`* &変数名: 値`** | \*\*`値`**を**`変数名`\*\*として定義します。 |

**⚠️ 注意事項**
この方法で変数に設定できるのは、**計算を含まない確定した値（定数）のみ**です。例えば、`1 + 2`のような計算式は使えず、\*\*`3`\*\*のように確定した値を記述する必要があります。

**✅ 使用例（設定できる値の型）**

| 設定する値の型 | 記述例 |
| :--- | :--- |
| **文字列** | `* &VERSION: "1.2.0"` |
| **数値** | `* &COUNT: 100` |
| **真偽値** | `* &IS_ACTIVE: true` |

| 元の記述（シート） | 最終的に展開されるイメージ（文書構造） |
| :--- | :--- |
| ` markdown # 設定シート * &VERSION: "1.2.0" // 変数を定義する（この行は出力されない） * 現在のバージョン情報: {{ VERSION }}  ` | ` markdown # 設定シート * 現在のバージョン情報: 1.2.0  ` |

-----

## 🛠️ 仕様が変更された機能

### 1\. 複数行テキストの継続方法の改善（重要）

リスト項目などの文章が長くなり、次の行にまたがるときの記述方法が大幅に簡単になりました。

#### 🔹 行末の `  + ` が省略可能に（自動継続）

以前は、次の行を継続行として結合したい場合、行末に必ず\*\*スペース＋プラス記号（`  + `）\*\*を付けていましたが、新しいバージョンでは、**適切なインデントで次の行を書き始めれば、`  + `を省略できます**。

| 以前の記述（`  + `が必須） | 新しい記述（`  + `が省略可能） |
| :--- | :--- |
| ` markdown * これは非常に長いリストの文章です + 続けて文章を記述します  ` | ` markdown * これは非常に長いリストの文章です 続けて文章を記述します  ` |

> **⚠️ 重要な変更点:** 互換性のために従来の **`  + ` の記述は残ります**が、新しい**自動継続の記述方法をご利用ください。今後は `  + ` の使用は非推奨**となります。

#### 🔹 明示的継続（`  + `）での空行挿入

行全体が\*\*`  + `のみ**の場合（前後に空白があってもよい）、その場所に**空行\*\*を挿入するためのマーカーとして機能するようになりました。

| 元の記述（シート） | 最終的に展開されるイメージ（文書構造） |
| :--- | :--- |
| ` markdown * 最初の文章です + + // この行が空行になる 次の文章です  ` | ` markdown * 最初の文章です <空行> 次の文章です  ` |

-----

### 2\. 未定義の参照に対する警告機能

**（上記2.の補足）**

存在しない変数名を**通常のプレースホルダー`{{...}}`で参照した場合（タイプミスなど）、エラーで処理が停止する代わりに、処理の最後に警告メッセージ**が表示されるようになりました。

さらに、参照ミスがあった**ファイル名と行番号**が\*\*`placeholder_warnings.txt`\*\*というファイルに出力されます。これにより、参照ミスを簡単に確認し、修正できるようになります。
