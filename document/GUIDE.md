# cltools Parse 新バージョンアップデートガイド（ユーザー向け）

この度のアップデートでは、シート（`.txt`ファイルなど）の記述方法がより簡単になり、出力したいExcelやその他の文書構造を、より柔軟に制御できるようになりました。

-----

## 💡 新しく追加された機能

### 1\. どこでも使えるプレースホルダーと変数のスコープ統一（最も重要！）

今回の変更で、変数の参照ルールが根本的に変わりました。

#### 🔹 テンプレート構造外での参照が可能に

**テンプレートの定義ブロック外**でも、プレースホルダーが使えるようになりました。

#### 🔹 テンプレート内での変数参照が自動化

旧バージョンでは、テンプレート内のプレースホルダーは、テンプレート呼び出し時に**引数として渡されたデータしか参照できませんでした**。

新バージョンでは、このルールが大きく変わり、**テンプレート呼び出しの引数ではない、同じ階層やそれより上の階層で定義された変数**を、テンプレート内から直接参照できるようになりました。

これにより、共通設定を**テンプレート呼び出しのたびに引数として渡す必要がなくなりました**。

**✅ 新しい動作のイメージ（サンプルコード）**

```
product_detail:
    name: "Tシャツ"

shop_name: "フジオカ商店"

```

```
- &item_template()
    - 商品名: {{name}}          // 旧バージョンから可能（引数経由）
    - 販売元: {{shop_name}}    // ★ 新機能：テンプレート内から直接参照可能

- *item_template(product_detail)

販売元を直接参照: {{shop_name}} // ★ 新機能：テンプレートの定義ブロック外でも参照可能
```

-----

### 2\. テンプレート呼び出しの回数指定（ループ）

特定のテンプレート（部品）を**決まった回数だけ繰り返し出力**したい場合に、回数を指定できるようになりました。

| 機能 | 説明 |
| :--- | :--- |
| **`*テンプレート名(N)`** | テンプレートを**N回**繰り返して出力します。 |

**✅ 使用例：基本的な繰り返し**

**① シートからの呼び出し**

```
# 請求先リスト

*Item(5) // Itemテンプレートを5回繰り返す
```

**② この記述で展開される結果のイメージ**

```
# 請求先リスト

* 1. 請求先名 (Itemの内容)
* 2. 請求先名 (Itemの内容)
* 3. 請求先名 (Itemの内容)
* 4. 請求先名 (Itemの内容)
* 5. 請求先名 (Itemの内容)
```

#### 🔹 繰り返し情報（連番）の利用

繰り返しの最中に、\*\*「今何回目か」\*\*の情報を取得して、連番や合計件数を表示できます。

| 変数名 | 説明 |
| :--- | :--- |
| **`{{ $index1 }}`** | **1から始まる**現在の回数（連番に便利） |

**✅ 使用例：連番の利用**

**Templateファイル（`Item`テンプレート）の記述**

```
* {{ $index1 }}. 請求先名
```

**展開される結果のイメージ**

```
* 1. 請求先名
* 2. 請求先名
// ... 続く
```

-----

### 3\. 条件付きコンテンツ（`{{?expr}}`）による行の制御 と 警告の抑制（重要）

新しい構文である\*\*`{{?変数名}}`\*\*は、「値がない場合の警告を抑制し、行を削除する」目的で使います。

| 構文 | 動作 | 目的 |
| :--- | :--- | :--- |
| **`{{変数名}}`** | 値がない（`null`や`undefined`）場合、**行を削除**し、処理後に**警告メッセージ**が出ます。 | 変数名のミスなど、**想定外のデータ欠損**を見つけるために使います。 |
| **`{{?変数名}}`** | 値がない（`null`や`undefined`）場合、**行を削除**しますが、**警告メッセージは一切出ません**。 | データがないことを**意図して**行を制御したい場合に使います。 |

> **（補足）行が削除される条件**
> 値が **`false`**、**`null`**、または **`undefined`** の場合に、行全体が削除されます。

**✅ 使用例（警告を出さずに行を制御する）**

**元の記述（シート）**

```
* 商品名: ノートPC
* {{? optionalMemo }} 備考: {{ optionalMemo }}
```

**展開される結果のイメージ（`optionalMemo`に値がない場合）**

```
* 商品名: ノートPC
// 備考の行は完全に消える（警告なし）
```

-----

### 4\. 新しい変数定義方法（`&Name:` アンカー）

リスト項目として**変数名とその値**を定義できるようになりました。この行は**最終的な出力には影響しません**。

| 構文 | 説明 |
| :--- | :--- |
| **`* &変数名: 値`** | \*\*`値`**を**`変数名`\*\*として定義します。 |

**⚠️ 注意事項：計算式は使えません**
設定できるのは、**計算を含まない確定した値（定数）のみ**です。（例: `1 + 2`ではなく\*\*`3`\*\*と記述）

**✅ 使用例（設定できる値の型）**

| 設定する値の型 | 記述例 |
| :--- | :--- |
| **文字列** | `* &VERSION: "1.2.0"` |
| **数値** | `* &COUNT: 100` |
| **真偽値** | `* &IS_ACTIVE: true` |

-----

### 5\. プレースホルダー内での計算や条件判定

値を参照するプレースホルダー`{{...}}`の中で、**簡単な計算**や**条件分岐の式**を直接記述できるようになりました。

| 機能 | 説明 |
| :--- | :--- |
| **`{{ A * B }}`** | 変数AとBを掛け算した結果を出力。 |
| **`{{ A > B ? "Yes" : "No" }}`** | AがBより大きければ"Yes"、そうでなければ"No"を出力。 |

**✅ 使用例（変数を使った計算の記述）**

**元の記述（シート）**

```
* &price: 1000   // 価格を定義
* &taxRate: 1.10 // 税率を定義

* 税抜金額: {{ price }}
* 税込金額: {{ price * taxRate }} // ★ プレースホルダー内で計算を実行
```

-----

## 🛠️ 仕様が変更された機能

### 1\. 複数行テキストの継続方法の改善（重要）

リスト項目などの文章が長くなり、次の行にまたがるときの記述方法が大幅に簡単になりました。

#### 🔹 行末の `  + ` が省略可能に（自動継続）

以前は必須だった行末の\*\*スペース＋プラス記号（`  + `）\*\*を、**適切なインデントで次の行を書き始めれば、省略できます**。

| 以前の記述（`  + `が必須） | 新しい記述（`  + `が省略可能） |
| :--- | :--- |
| **`* これは長いリストの文章です +`**<br>**`   続けて文章を記述します `** | **`* これは長いリストの文章です`**<br>**`   続けて文章を記述します `** |

> **⚠️ 重要な変更点:** 互換性のために従来の **`  + ` の記述は残ります**が、新しい**自動継続の記述方法をご利用ください。今後は `  + ` の使用は非推奨**となります。

#### 🔹 明示的継続（`  + `）での空行挿入

行全体が\*\*`  + `のみ**の場合（前後に空白があってもよい）、その場所に**空行\*\*を挿入するためのマーカーとして機能するようになりました。

**元の記述（シート）**

```
* 最初の文章です +
+ // この行が空行になる
次の文章です
```

**展開される結果のイメージ（文書構造）**

```
* 最初の文章です

次の文章です
```

-----

### 2\. コメントの解釈変更によるURL記述の許可

行末のコメント（`//`）の解釈方法が変更されました。

| 変更前（旧バージョン） | 変更後（新バージョン） |
| :--- | :--- |
| 行の途中に\*\*`//`**があれば、そこから右側は**無条件でコメントとして削除\*\*されていました。 | **行頭**か、\*\*テキストの後に空白を挟んだ`  // `\*\*がある場合のみ、コメントとして削除されます。 |

**✅ 変更によるメリット**

URLなど、\*\*空白を挟まない`//`\*\*を含むテキストを、意図通りに出力できるようになりました。

**元の記述（シート）**

```
* 開発資料: https://example.com/api/v2/items 
* バージョン比較: old_version//new_version
```

**展開される結果のイメージ**

```
* 開発資料: https://example.com/api/v2/items 
* バージョン比較: old_version//new_version // ★ URL内の // が保持される
```

-----

### 3\. 未定義の参照に対する警告機能

存在しない変数名を**通常のプレースホルダー`{{...}}`で参照した場合（タイプミスなど）、エラーで処理が停止する代わりに、処理の最後に警告メッセージ**が表示されるようになりました。

さらに、参照ミスがあった**ファイル名と行番号**が\*\*`placeholder_warnings.txt`\*\*というファイルに出力されます。これにより、参照ミスを簡単に確認し、修正できるようになります。
